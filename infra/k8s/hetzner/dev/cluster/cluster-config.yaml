---
# SCOPE: This file controls CLUSTER PROVISIONING (infrastructure-level)
#        K3s cluster creation, node pools, networking, etc.
#
# NOTE: For APPLICATION DEPLOYMENT controls (PostgreSQL, services, etc.), see:
#   infra/deploy-control.yaml
#
# WORKFLOWS:
#   - Cluster provisioning: .github/workflows/hetzner-k8s.yml (reads this file)
#   - Resource deployment: .github/workflows/deploy-k8s-resources.yml (reads deploy-control.yaml)

auto_deploy: true # Set to false to disable automatic cluster provisioning
hetzner_token: HETZNER_TOKEN # Will be replaced by GitHub Actions from secrets
cluster_name: hetzner-dev-cluster
kubeconfig_path: "./kubeconfig" # or /cluster/kubeconfig if hetzner-k8s is installed in Docker instead
k3s_version: v1.32.0+k3s1

networking:
  ssh:
    port: 22
    use_agent: true
    public_key_path: "~/.ssh/id_rsa.pub"
    private_key_path: "~/.ssh/id_rsa"
  allowed_networks:
    ssh:
      - 0.0.0.0/0 # TODO: Restrict to your IP after initial setup
    api:
      - 0.0.0.0/0 # TODO: Restrict to your IP after initial setup
    # Custom firewall rules to ensure outbound access for image pulling
    # IMPORTANT: Defining ANY outbound rule switches to deny-all by default
    # These rules ensure nodes can pull images from public registries
    custom_firewall_rules:
      - description: "Allow DNS (outbound)"
        direction: out
        protocol: udp
        port: "53"
        destination_ips:
          - 0.0.0.0/0
      - description: "Allow HTTPS to public registries (outbound)"
        direction: out
        protocol: tcp
        port: "443"
        destination_ips:
          - 0.0.0.0/0
      - description: "Allow HTTP to public registries (outbound)"
        direction: out
        protocol: tcp
        port: "80"
        destination_ips:
          - 0.0.0.0/0
  public_network:
    ipv4: true
    ipv6: true
  private_network:
    enabled: true
    subnet: 10.0.0.0/16
  cni:
    enabled: true
    encryption: true
    mode: flannel

schedule_workloads_on_masters: false

datastore:
  mode: etcd

masters_pool:
  instance_type: cpx11
  instance_count: 1
  locations:
    - ash

worker_node_pools:
  - name: small-static
    instance_type: cpx21
    instance_count: 1
    location: ash
  - name: medium-autoscaled
    instance_type: cpx21
    location: ash
    autoscaling:
      enabled: true
      min_instances: 0
      max_instances: 1

protect_against_deletion: true

embedded_registry_mirror:
  enabled: true # Enables fast p2p distribution of container images between nodes for faster pod startup

k3s_upgrade_concurrency: 1 # how many nodes to upgrade at the same time
